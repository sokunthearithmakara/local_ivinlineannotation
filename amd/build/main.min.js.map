{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["/* eslint-disable complexity */\n\n\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main class for inlineannotation content type\n *\n * @module     local_ivinlineannotation/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nimport ModalForm from 'core_form/modalform';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {notifyFilterContentUpdated as notifyFilter} from 'core_filters/events';\nexport default class InlineAnnotation extends Base {\n    /**\n     * Callback function to be executed after an edit operation.\n     * Currently, this function does not perform any actions.\n     */\n    postEditCallback() {\n        // Do nothing\n    }\n\n    /**\n     * Round a number to two decimal places\n     * @param {Number} num Number\n     * @returns {Number} rounded number\n     */\n    roundToTwo(num) {\n        return +(Math.round(num + 'e+2') + 'e-2');\n    }\n\n    /**\n     * Render the container for the annotation.\n     * @param {Object} annotation The annotation object.\n     * @return {void}\n     */\n    renderContainer(annotation) {\n        const videoWrapper = $('#video-wrapper');\n        videoWrapper.find('#canvas').remove();\n        videoWrapper.append(`<div id=\"canvas\" data-id=\"${annotation.id}\"\n             class=\"message text-white bg-transparent inlineannotation position-absolute\" tabindex=\"0\"></div>`);\n\n        const updateAspectRatio = async(video, reset) => {\n            let elem = video ? $('#player') : $(`#canvas[data-id='${annotation.id}']`);\n            if ($(\"#wrapper\").hasClass('fullscreen')) {\n                let ratio = 16 / 9;\n                if (!this.displayoptions.usefixedratio || this.displayoptions.usefixedratio == 0) {\n                    ratio = this.player.aspectratio;\n                }\n                let videowrapperaspect = videoWrapper.width() / videoWrapper.height();\n                const videowrapperwidth = videoWrapper.width();\n                const videowrapperheight = videoWrapper.height();\n                // Screen is wider than the video.\n                if (videowrapperaspect > ratio) {\n                    let height = videowrapperheight;\n                    let width = height * ratio;\n                    elem.css('height', height + 'px');\n                    elem.css('width', width + 'px');\n                    elem.css('top', '0');\n                    elem.css('left', (videowrapperwidth - width) / 2 + 'px');\n                } else if (videowrapperaspect < ratio) {\n                    let width = videowrapperwidth;\n                    let height = width / ratio;\n                    elem.css('width', width + 'px');\n                    elem.css('height', height + 'px');\n                    elem.css('top', ((videowrapperheight - height) / 2) + 'px');\n                    elem.css('left', '0');\n                }\n            } else {\n                elem.css('width', '100%');\n                elem.css('height', '100%');\n                elem.css('top', '0');\n                elem.css('left', '0');\n            }\n            if (reset) {\n                elem.css('width', '100%');\n                elem.css('height', '100%');\n                elem.css('top', '0');\n                elem.css('left', '0');\n            }\n        };\n\n        updateAspectRatio();\n        updateAspectRatio(true);\n\n        let vwrapper = document.querySelector('#video-wrapper');\n        let resizeTimeout;\n        let resizeObserver = new ResizeObserver(() => {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(() => {\n            updateAspectRatio();\n            updateAspectRatio(true);\n            }, 100);\n        });\n\n        resizeObserver.observe(vwrapper);\n\n        $(document).on('timeupdate', function() {\n            updateAspectRatio(true, true);\n        });\n    }\n\n    /**\n     * Util function to input the timestamp on the modal form.\n     * @param {Object} options The options\n     * @returns {void}\n     * */\n    timepicker(options) {\n        // Normalize the options.\n        options = options || {};\n        options.modal = options.modal || true;\n        options.disablelist = options.disablelist || false;\n        options.required = options.required || false;\n        let self = this;\n        $(document).off('click', '#confirmtime');\n        // Pick a time button.\n        $(document).off('click', `.pickatime button`).on('click', `.pickatime button`, async function(e) {\n            e.preventDefault();\n            const $this = $(this);\n            const currenttime = await self.player.getCurrentTime();\n            const field = $(this).data('field');\n            const fieldval = $(`[name=${field}]`).val();\n            if (fieldval) {\n                const parts = fieldval.split(':');\n                const time = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                await self.player.seek(time); // Go to the time.\n            }\n            // Hide this modal.\n            if (options.modal) {\n                $this.closest('.modal').addClass('d-none');\n                $('.modal-backdrop').addClass('d-none');\n            }\n            if (options.disablelist) {\n                $('#annotationwrapper').addClass('no-pointer-events');\n            }\n            $('#timeline-btns .col:first-child').hide().before(`<div class=\"col confirmtime-wrapper\n                    d-flex justify-content-start align-items-center\n                         \"><button class=\"btn btn-circle pulse btn-primary\" id=\"confirmtime\"\n                         title=\"${M.util.get_string('confirmtime', 'ivplugin_contentbank')}\">\n                         <i class=\"fa fa-check\"></i></button></div>`);\n            $('#timeline-wrapper').removeClass('no-pointer-events');\n            // Hide the annotation-wrapper.\n            $('#canvas .annotation-wrapper').css('visibility', 'hidden');\n\n            $(document).on('click', '#confirmtime', async function(e) {\n                e.preventDefault();\n                // Show the modal.\n                if (options.modal) {\n                    $this.closest('.modal').removeClass('d-none');\n                    $('.modal-backdrop').removeClass('d-none');\n                }\n                if (options.disablelist) {\n                    $('#annotationwrapper').removeClass('no-pointer-events');\n                }\n                // Remove the button.\n                // Put the time in the input.\n                const time = await self.player.getCurrentTime();\n                const formattedTime = self.convertSecondsToHMS(time, false, true);\n                $(`[name=${field}]`).val(formattedTime);\n                $(this).closest('div').remove();\n                $('#timeline-btns .col:first-child').show();\n                // Go back to the current time.\n                self.player.seek(currenttime);\n                $('#timeline-wrapper').addClass('no-pointer-events');\n                self.player.pause();\n                $('#canvas .annotation-wrapper').css('visibility', 'visible');\n            });\n        });\n\n        // Reset time button.\n        $(document).off('click', `.resettime button`).on('click', `.resettime button`, function(e) {\n            e.preventDefault();\n            const field = $(this).data('field');\n            $(`[name=${field}]`).val('');\n            if (options.required) {\n                $(`[name=${field}]`).val(self.convertSecondsToHMS(self.start, false, true));\n            }\n        });\n\n    }\n\n    /**\n     * Post-processes the content after rendering an annotation.\n     * @param {Object} annotation The annotation object.\n     * @param {Object} data The data object.\n     * @return {void}\n     */\n    postContentRender(annotation, data) {\n        let self = this;\n        let $videoWrapper = $('#video-wrapper');\n        let $playerWrapper = $('#wrapper');\n        let $canvas = $('#canvas');\n        let draftStatus = null;\n        let seeking = false;\n        /**\n         * Format seconds to HH:MM:SS\n         * @param {Number} seconds seconds\n         * @returns formatted time\n         */\n        const convertSecondsToMMSS = (seconds) => {\n            let minutes = Math.floor(seconds / 60);\n            seconds = Math.round(seconds - minutes * 60);\n            return (minutes < 10 ? '0' + minutes : minutes) + ':' + (seconds < 10 ? '0' + seconds : seconds);\n        };\n\n        /**\n         * Update position information of the active element on the toolbar.\n         * @param {Object} elem jQuery element\n         */\n        const updatePositionInfo = (elem) => {\n            let w = elem.outerWidth();\n            let hw = elem.outerHeight();\n            let t = elem.position().top < 0 ? 0 : elem.position().top;\n            let l = elem.position().left < 0 ? 0 : elem.position().left;\n            let z = elem.css('z-index');\n            $(`#inlineannotation-btns #position`)\n                .text(`x: ${Math.round(l)}, y: ${Math.round(t)}, z: ${z - 5}, w: ${Math.round(w)}, h: ${Math.round(hw)}`);\n        };\n\n        /**\n         * Recalculate the size of the element.\n         * @param {Object} elem jQuery element\n         * @return {Object} position of the element\n         */\n        const recalculatingSize = (elem) => {\n            let message = $videoWrapper.find(`#canvas`);\n            $(`#inlineannotation-btns #down, #inlineannotation-btns #up`).removeAttr('disabled');\n            let w = self.roundToTwo(elem.outerWidth()) / message.width() * 100;\n            let h = self.roundToTwo(elem.outerHeight()) / message.height() * 100;\n            let t = self.roundToTwo(elem.position().top) / message.height() * 100;\n            t = t < 0 ? 0 : t;\n            let l = self.roundToTwo(elem.position().left) / message.width() * 100;\n            l = l < 0 ? 0 : l;\n            let z = elem.css('z-index');\n            let g = elem.data('group');\n            let position = {\n                'width': w + '%',\n                'height': h + '%',\n                'left': l + '%',\n                'top': t + '%',\n                'z-index': z,\n            };\n            position.group = g;\n            elem.css(position);\n            updatePositionInfo(elem);\n            return position;\n        };\n\n        /**\n         * Calculate the text size for text and file type.\n         * @param {Object} elem jQuery element\n         * @param {Boolean} button if it is a button\n         * @param {Boolean} multiline if it is a multiline text\n         */\n        const recalculatingTextSize = (elem, button, multiline = false) => {\n            let fontSize = elem.outerHeight();\n            let padding = 0;\n            let rowCount = 1;\n            if (multiline) {\n                let rows = elem.find('.text-row');\n                rowCount = rows.length;\n                if (rowCount > 1) {\n                    let rowHeight = elem.outerHeight() / rowCount;\n                    padding = rowHeight * 0.3;\n                    fontSize = (elem.outerHeight() - padding * 2) / rowCount;\n                }\n            }\n            let style = {\n                'font-size': (button ? fontSize * 0.7 : fontSize * 0.9) + 'px',\n                'line-height': fontSize + 'px',\n                'padding-left': (button ? fontSize * 0.5 : fontSize * 0.3) + 'px',\n                'padding-right': (button ? fontSize * 0.5 : fontSize * 0.3) + 'px',\n            };\n            if (multiline && rowCount > 1) {\n                style.padding = padding + 'px';\n            }\n            elem.find('.annotation-content').css(style);\n            elem.css('width', 'auto');\n        };\n\n        const renderImage = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = parts.length > 0 ? Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]) : -1;\n            if (prop.gotourl != '') {\n                wrapper.append(`<a href=\"${prop.gotourl}\" target=\"_blank\"><img src=\"${prop.url}\" id=\"${id}\"\n                             class=\"annotation-content w-100 ${prop.shadow == '1' ? 'shadow' : ''}\"\n                             ${prop.rounded == 1 ? 'style=\"border-radius:1em;\"' : ''} alt=\"${prop.formattedalttext}\"/></a>`);\n            } else {\n                wrapper.append(`<img src=\"${prop.url}\" id=\"${id}\"\n                                  class=\"annotation-content w-100 ${prop.shadow == '1' ? 'shadow' : ''}\n                                  ${timestamp >= 0 ? 'cursor-pointer' : ''}\"\n                                   ${prop.rounded == 1 ? 'style=\"border-radius:1em;\"' : ''} alt=\"${prop.formattedalttext}\"/>`);\n            }\n            if (!self.isEditMode()) {\n                if (prop.gotourl == '' && timestamp < 0) {\n                    wrapper.removeClass('resizable');\n                    wrapper.addClass('no-pointer');\n                } else {\n                    wrapper.addClass('clickable');\n                    if (timestamp >= 0) {\n                        wrapper.attr('data-timestamp', timestamp);\n                    }\n                }\n            }\n            wrapper.css(position);\n            wrapper.css('height', 'auto');\n            $canvas.append(wrapper);\n        };\n\n        const renderVideo = (wrapper, item, prop, id, position) => {\n            wrapper.append(`<video id=\"${id}\" class=\"annotation-content w-100 ${prop.shadow == '1' ? 'shadow' : ''}\"\n                 ${prop.showcontrol == 1 && !self.isEditMode() ? 'controls' : ''}\n                  ${$('body').hasClass('mobiletheme') ? 'preload=\"auto\"' : ''}\n                 src=\"${prop.url}\" style=\"border-radius: ${prop.rounded == 1 ? '1em' : '0'}\" disablePictureInPicture/></video>\n             <i class=\"playpause bi bi-play-fill position-absolute\" style=\"font-size: 2em; line-height:: 2em;\"></i>`);\n            let video = wrapper.find('video')[0];\n            video.autoplay = prop.autoplay == '1';\n            video.playsInline = true;\n            if (self.isEditMode()) {\n                video.autoplay = false;\n            }\n            video.onplay = function() {\n                wrapper.find('.playpause').removeClass('bi-play-fill').addClass('bi-pause-fill');\n            };\n            video.onpause = function() {\n                wrapper.find('.playpause').removeClass('bi-pause-fill').addClass('bi-play-fill');\n            };\n            video.onended = function() {\n                wrapper.find('.playpause').removeClass('bi-pause-fill').addClass('bi-play-fill');\n            };\n            wrapper.css(position);\n            $canvas.append(wrapper);\n            recalculatingSize(wrapper);\n        };\n\n        const renderFile = (wrapper, item, prop, id, position) => {\n            const type = item.type;\n            let wrapperhtml = ``;\n            if (type == 'audio') {\n                wrapperhtml = `<span id=\"${id}\" tabindex=\"0\"\n                             class=\"btn ${prop.style} ${prop.rounded == '1' ? 'btn-rounded' : 'iv-rounded-0'}\n                              annotation-content text-nowrap ${prop.shadow == '1' ? 'shadow' : ''} rotatex-360\"\n                               data-src=\"${prop.url}\"><i class=\"bi bi-volume-up fs-unset\" style=\"margin-right:0.25em;\"></i>\n                               <span class=\"timeremaining\">00:00</span></span>`;\n            } else if (type == 'file') {\n                wrapperhtml = `<a id=\"${id}\"\n                             class=\"btn ${prop.style} ${prop.rounded == '1' ? 'btn-rounded' : 'iv-rounded-0'}\n                             annotation-content text-nowrap ${prop.shadow == '1' ? 'shadow' : ''} rotatey-180\" href=\"${prop.url}\"\n                              target=\"_blank\"><i class=\"bi bi-paperclip fs-unset\"></i>${prop.formattedlabel != \"\" ?\n                        `<span style=\"margin-left:0.25em;\">${prop.formattedlabel}` : ''}</a>`;\n            }\n            wrapper.append(`<div class=\"d-flex h-100\">${wrapperhtml}</div>`);\n\n            if (type == 'audio' && !self.isEditMode()) {\n                let playButton = wrapper.find('.annotation-content');\n                let audioSrc = prop.url;\n                let media = new Audio(audioSrc);\n                playButton.off('click').on('click', function(e) {\n                    e.stopImmediatePropagation();\n                    if (media.paused || media.ended || media.currentTime === 0) {\n                        media.play();\n                        $(this).find('i').removeClass('bi-volume-up').addClass('bi-pause-fill');\n                    } else {\n                        media.pause();\n                        $(this).find('i').removeClass('bi-pause-fill').addClass('bi-volume-up');\n                    }\n                });\n\n                let totaltime = 0;\n                media.onloadedmetadata = function() {\n                    totaltime = media.duration;\n                    playButton.find('span.timeremaining').text(convertSecondsToMMSS(totaltime));\n                };\n\n                media.onended = function() {\n                    playButton.find('i').removeClass('bi-pause-fill').addClass('bi-volume-up');\n                    playButton.find('span.timeremaining').text(convertSecondsToMMSS(totaltime));\n                };\n\n                media.ontimeupdate = function() {\n                    playButton.find('span.timeremaining')\n                        .text(convertSecondsToMMSS(media.duration - media.currentTime));\n                };\n\n                if (prop.autoplay == '1') {\n                    setTimeout(() => {\n                        playButton.trigger('click');\n                    }, 100);\n                }\n\n                $(document).one('iv:playerSeek iv:playerPlay', function() {\n                    if (media) {\n                        media.pause();\n                    }\n                });\n            }\n\n            position.width = 0;\n\n            wrapper.css(position);\n            $canvas.append(wrapper);\n            recalculatingTextSize(wrapper, true);\n        };\n\n        const renderNavigation = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n\n            wrapper.append(`<div class=\"d-flex h-100\"><span id=\"${id}\" tabindex=\"0\" class=\"btn ${prop.style} ${prop.rounded == '1' ?\n                'btn-rounded' : 'iv-rounded-0'} annotation-content text-nowrap ${prop.shadow == '1' ? 'shadow' : ''}\">\n                ${prop.formattedlabel}</span></div>`);\n\n            position.width = 0;\n            wrapper.attr('data-timestamp', timestamp);\n            wrapper.css(position);\n            $canvas.append(wrapper);\n            recalculatingTextSize(wrapper, true);\n        };\n\n        const renderStopwatch = (wrapper, item, prop, id, position) => {\n            const duration = Number(prop.duration) * 60;\n            wrapper.append(`<div class=\"d-flex h-100\"><span id=\"${id}\" tabindex=\"0\"\n                             class=\"btn ${prop.style} ${prop.rounded == '1' ? 'btn-rounded' : 'iv-rounded-0'}\n                              annotation-content text-nowrap ${prop.shadow == '1' ? 'shadow' : ''} rotatey-180\"\n                               data-duration=\"${duration}\">\n                               <i class=\"bi bi bi-stopwatch fs-unset\" style=\"margin-right:0.25em;\"></i>\n                               <span>${convertSecondsToMMSS(duration)}</span></span></div>`);\n\n            let timer, alarm;\n            if (timer) {\n                clearInterval(timer);\n            }\n            const intervalfunction = function() {\n                timer = setInterval(() => {\n                    $(`.annotation-content#${id}`).addClass('running');\n                    let time = $(`.annotation-content#${id}`).data('duration');\n                    time--;\n                    $(`.annotation-content#${id} span`).text(convertSecondsToMMSS(time));\n                    $(`.annotation-content#${id}`).data('duration', time);\n                    if (prop.playalarmsound.playsoundatinterval == '1'\n                        && time % (prop.playalarmsound.intervaltime * 60) == 0) {\n                        if (prop.playalarmsound.playsoundatend == 1) {\n                            alarm = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/short-alarm.mp3');\n                            alarm.play();\n                        }\n                    }\n                    if (time < 0) {\n                        clearInterval(timer);\n                        if (prop.playalarmsound.playsoundatend == 1) {\n                            alarm = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/alarm.mp3');\n                            alarm.play();\n                            alarm.onplay = function() {\n                                $(`.annotation-content#${id}`).addClass('pulse');\n                            };\n                            alarm.onended = function() {\n                                $(`.annotation-content#${id}`).removeClass('pulse');\n                            };\n                        }\n                        $(`.annotation-content#${id}`).removeClass('running');\n                        $(`.annotation-content#${id} span`).text(convertSecondsToMMSS(duration));\n                        $(`.annotation-content#${id}`).data('duration', duration);\n                    }\n                }, 1000);\n            };\n\n            if (!self.isEditMode()) {\n                intervalfunction();\n                $videoWrapper.off('click', `.annotation-content#${id}`).on('click', `.annotation-content#${id}`, function(e) {\n                    e.stopImmediatePropagation();\n                    if (prop.allowpause == 1) {\n                        if ($(this).hasClass('running')) {\n                            clearInterval(timer);\n                            if (alarm) {\n                                alarm.pause();\n                            }\n                            $(this).removeClass('running');\n                        } else {\n                            intervalfunction();\n                        }\n                    } else if ($(this).data('duration') == duration) {\n                        intervalfunction();\n                    }\n                });\n            }\n\n            $(document).one('iv:playerSeek', function() {\n                clearInterval(timer);\n            });\n\n            position.width = 0;\n\n            wrapper.css(position);\n            $canvas.append(wrapper);\n            recalculatingTextSize(wrapper, true);\n        };\n\n        const renderTextblock = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = parts.length > 0 ? Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]) : -1;\n            const textparts = prop.formattedlabel.split('\\r\\n');\n            let textblock = '<div class=\"d-flex flex-column\">';\n            textparts.forEach((part) => {\n                if (part.trim() == '') {\n                    return;\n                }\n                textblock += `<span class=\"text-row text-nowrap iv-text-${prop.alignment}\"\n                                 style='font-family: ${prop.textfont != '' ? prop.textfont : 'inherit'}'>${part}</span>`;\n            });\n            textblock += '</div>';\n            if (prop.url != undefined && prop.url != '') {\n                wrapper.append(`<a id=\"${id}\"\n                                     class=\"annotation-content d-block ${prop.shadow == '1' ? 'text-shadow' : ''}\"\n                                      href=\"${prop.url}\" target=\"_blank\">${textblock}</a>`);\n                wrapper.addClass('clickable');\n            } else {\n                wrapper.append(`<div id=\"${id}\"\n                                     class=\"annotation-content ${prop.shadow == '1' ? 'text-shadow' : ''}\n                                     \">${textblock}</div>`);\n            }\n            wrapper.position.width = 0;\n            wrapper.css(position);\n            const style = {\n                'font-size': item.position.fontSize,\n                'line-height': item.position.lineHeight,\n                'font-weight': prop.bold == '1' ? 'bold' : 'normal',\n                'font-style': prop.italic == '1' ? 'italic' : 'normal',\n                'text-decoration': prop.underline == '1' ? 'underline' : 'none',\n                'color': prop.textcolor,\n                'background': prop.bgcolor,\n                'border-radius': prop.rounded == '1' ? '0.3em' : '0',\n                'border-width': prop.borderwidth,\n                'border-color': prop.bordercolor,\n                'border-style': 'solid',\n            };\n            if (timestamp >= 0) {\n                wrapper.attr('data-timestamp', timestamp);\n                wrapper.addClass('clickable');\n            }\n            wrapper.find('.annotation-content').css(style);\n            $canvas.append(wrapper);\n            recalculatingTextSize(wrapper, false, true);\n        };\n\n        const renderShape = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = parts.length > 0 ? (Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2])) : -1;\n            if (prop.gotourl != '') {\n                wrapper.append(`<a href=\"${prop.gotourl}\" target=\"_blank\"><div id=\"${id}\"\n                             class=\"annotation-content ${prop.shadow == '1' ? 'shadow' : ''}\"\n                              style=\"width: 100%; height: 100%;\"></div></a>`);\n                wrapper.addClass('clickable');\n            } else {\n                if (!self.isEditMode()) {\n                    if (timestamp >= 0) {\n                        wrapper.addClass('clickable');\n                    } else {\n                        wrapper.addClass('no-pointer');\n                    }\n                }\n                wrapper.append(`<div id=\"${id}\" class=\"annotation-content ${prop.shadow == '1' ? 'shadow' : ''}\n                                 ${timestamp > 0 ? 'cursor-pointer' : ''}\"\n                             style=\"width: 100%; height: 100%;\"></div>`);\n            }\n            if (timestamp >= 0) {\n                wrapper.attr('data-timestamp', timestamp);\n            }\n            wrapper.css(position);\n            const style = {\n                'background': prop.bgcolor,\n                'border-width': prop.borderwidth,\n                'border-color': prop.bordercolor,\n                'border-style': 'solid',\n                'opacity': prop.opacity / 100,\n            };\n            if (prop.shape == 'circle') {\n                style['border-radius'] = '50%';\n            } else if (prop.shape == 'rectangle') {\n                style['border-radius'] = prop.rounded == '1' ? '1em' : '0';\n            }\n            wrapper.find('.annotation-content').css(style);\n            $canvas.append(wrapper);\n        };\n\n        const renderHotspot = (wrapper, item, prop, id, position) => {\n            wrapper.append(`<div id=\"${id}\" class=\"annotation-content shadow-sm pulse\" role=\"button\"\n                 title=\"${prop.formattedtitle}\"></div>`);\n            position['aspect-ratio'] = '1';\n            wrapper.css(position);\n            const style = {\n                'background-color': prop.color,\n                'opacity': prop.opacity / 100,\n                'border-radius': '50%',\n                'aspect-ratio': '1',\n            };\n            wrapper.find('.annotation-content').css(style);\n            $canvas.append(wrapper);\n\n            if (!self.isEditMode()) {\n                if (prop.usemodal == '1') {\n                    if (self.isBS5) {\n                        wrapper.attr({\n                            'data-bs-toggle': 'modal',\n                        });\n                    } else {\n                        wrapper.attr({\n                            'data-toggle': 'modal',\n                        });\n                    }\n                } else {\n                    let attr = {\n                        'tabindex': -1,\n                    };\n                    if (self.isBS5) {\n                        attr['data-bs-trigger'] = 'manual';\n                        attr['data-bs-boundary'] = 'viewport';\n                        attr['data-bs-placement'] = 'auto';\n                        attr['data-bs-html'] = 'true';\n                        attr['data-bs-content'] = '<div class=\"loader\"></div>';\n                        attr['data-bs-title'] = prop.formattedtitle\n                            + `<i class=\"bi bi-x-circle-fill iv-ml-auto popover-dismiss cursor-pointer\"\n                                     style=\"font-size:1.5em;\"></i>`;\n                    } else {\n                        attr['data-trigger'] = 'manual';\n                        attr['data-boundary'] = 'viewport';\n                        attr['data-placement'] = 'auto';\n                        attr['data-html'] = 'true';\n                        attr['data-content'] = '<div class=\"loader\"></div>';\n                        attr['data-title'] = prop.formattedtitle\n                            + `<i class=\"bi bi-x-circle-fill iv-ml-auto popover-dismiss cursor-pointer\"\n                                     style=\"font-size:1.5em;\"></i>`;\n                    }\n\n                    wrapper.attr(attr);\n\n                    wrapper.popover({\n                        container: '#wrapper',\n                        html: true,\n                        template: `<div class=\"popover inlineannotation-popover id-${id}\"\n                                     role=\"tooltip\"><div class=\"arrow\"></div>\n                                     <h3 class=\"popover-header d-flex justify-content-between\"></h3>\n                                     <div class=\"popover-body rounded\"></div>${prop.url != '' ?\n                                `<div class=\"popup-footer bg-light p-2 rounded-bottom\"><a href=\"${prop.url}\"\n                                          class=\"d-block w-100 text-right rotatex-360\" target=\"_blank\">\n                                          <i class=\"bi bi-arrow-right\"><i></i></i></a></div>` : ''}</div>`,\n                    });\n\n                    wrapper.on('shown.bs.popover', async function() {\n                        let $body = $(`.popover.id-${id} .popover-body`);\n                        const html = await self.formatContent(prop.content.text, annotation.contextid);\n                        $body.html(html);\n                        notifyFilter($body);\n                        wrapper.popover('update');\n                    });\n                    if (prop.openbydefault == '1') {\n                        wrapper.popover('show');\n                    }\n                }\n            }\n        };\n\n        const renderItems = (elements, actives, update) => {\n            if (!update) { // Clear the canvas if it is a new start.\n                $canvas.empty();\n            }\n\n            if (elements.length == 0) {\n                if (actives) {\n                    actives.forEach((active) => {\n                        $canvas.find(`.annotation-wrapper[data-item=\"${active}\"]`).addClass('active');\n                    });\n                }\n            } else {\n                let count = 0;\n                elements.forEach((item) => {\n                    let prop = item.properties;\n                    let type = item.type;\n                    let id = item.id;\n                    let position = item.position;\n                    if (!self.isEditMode()) {\n                        const left = position.left.replace('%', '');\n                        const top = position.top.replace('%', '');\n                        const width = position.width.replace('%', '');\n                        const height = position.height ? position.height.replace('%', '') : 0;\n                        if (left < 0.01) {\n                            position.left = '0%';\n                        }\n                        if (top < 0.01) {\n                            position.top = '0%';\n                        }\n                        if (width > 99.5) {\n                            position.width = '100%';\n                        }\n                        if (height > 99.5) {\n                            position.height = '100%';\n                        }\n                    }\n                    let wrapper = $(`<div class=\"annotation-wrapper\" data-group=\"${position.group}\" data-anno=\"${annotation.id}\"\n                     data-item=\"${id}\" data-type=\"${type}\"></div>`);\n                    if (prop.resizable == '1' || self.isEditMode()) {\n                        wrapper.addClass('resizable');\n                        wrapper.attr('tabindex', 0);\n                    }\n\n                    switch (type) {\n                        case 'image':\n                            renderImage(wrapper, item, prop, id, position);\n                            break;\n                        case 'video':\n                            renderVideo(wrapper, item, prop, id, position);\n                            break;\n                        case 'file':\n                        case 'audio':\n                            renderFile(wrapper, item, prop, id, position);\n                            break;\n                        case 'navigation':\n                            renderNavigation(wrapper, item, prop, id, position);\n                            break;\n                        case 'stopwatch':\n                            renderStopwatch(wrapper, item, prop, id, position);\n                            break;\n                        case 'textblock':\n                            renderTextblock(wrapper, item, prop, id, position);\n                            break;\n                        case 'shape':\n                            renderShape(wrapper, item, prop, id, position);\n                            break;\n                        case 'hotspot':\n                            renderHotspot(wrapper, item, prop, id, position);\n                            break;\n                    }\n\n                    count++;\n                    if (count == elements.length) {\n                        $canvas.find('.annotation-wrapper.resizable').draggable({\n                            containment: \"#canvas\",\n                            cursor: \"move\",\n                            grid: [1, 1],\n                            handle: '.annotation-content',\n                            start: function() {\n                                // Get all the selected elements\n                                if (!$(this).hasClass('active')) {\n                                    $(this).trigger('click');\n                                }\n                                let $selected = $canvas.find('.annotation-wrapper.active');\n                                $selected.each(function() {\n                                    $(this).data('startPosition', $(this).position());\n                                });\n                            },\n                            drag: function(event, ui) {\n                                let $selected = $canvas.find('.annotation-wrapper.active');\n                                let left = ui.originalPosition.left - ui.position.left;\n                                let top = ui.originalPosition.top - ui.position.top;\n                                let positions = $selected.map(function() {\n                                    return {\n                                        id: $(this).data('item'),\n                                        left: $(this).position().left,\n                                        top: $(this).position().top,\n                                        bottom: $(this).position().top + $(this).height(),\n                                        right: $(this).position().left + $(this).width(),\n                                    };\n                                }).get();\n\n                                if (positions.find(x => x.left < 0)) {\n                                    // Sort the elements by left position to get the leftmost element\n                                    positions.sort((a, b) => a.left - b.left);\n                                    let onLeft = positions.find(x => x.left < 0);\n                                    let id = onLeft.id;\n                                    let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                    target.css('left', 0);\n                                    let distance = target.data('startPosition').left;\n                                    ui.position.left = ui.originalPosition.left - distance;\n                                    left = ui.originalPosition.left - ui.position.left;\n                                }\n\n                                if (positions.find(x => x.top < 0)) {\n                                    positions.sort((a, b) => a.top - b.top);\n                                    let onTop = positions.find(x => x.top < 0);\n                                    let id = onTop.id;\n                                    let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                    target.css('top', 0);\n                                    let distance = target.data('startPosition').top;\n                                    ui.position.top = ui.originalPosition.top - distance;\n                                    top = ui.originalPosition.top - ui.position.top;\n                                }\n\n                                let canvasWidth = $canvas.width();\n                                let canvasHeight = $canvas.height();\n                                if (positions.find(x => x.right > canvasWidth)) {\n                                    positions.sort((a, b) => a.right - b.right);\n                                    let onRight = positions.find(x => x.right > $canvas.width());\n                                    let id = onRight.id;\n                                    let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                    target.css('left', (canvasWidth - target.width() - 1) + 'px');\n                                    let distance = target.data('startPosition').left - target.position().left;\n                                    ui.position.left = ui.originalPosition.left - distance;\n                                    left = ui.originalPosition.left - ui.position.left;\n                                }\n\n                                if (positions.find(x => x.bottom > canvasHeight)) {\n                                    positions.sort((a, b) => a.bottom - b.bottom);\n                                    let onBottom = positions.find(x => x.bottom > canvasHeight);\n                                    let id = onBottom.id;\n                                    let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                    target.css('top', (canvasHeight - target.height() - 1) + 'px');\n                                    let distance = target.data('startPosition').top - target.position().top;\n                                    ui.position.top = ui.originalPosition.top - distance;\n                                    top = ui.originalPosition.top - ui.position.top;\n                                }\n\n                                $selected.not(this).each(function() {\n                                    let $this = $(this);\n                                    const position = $this.data('startPosition');\n                                    $this.css({\n                                        left: (position.left - left) + 'px',\n                                        top: (position.top - top) + 'px',\n                                    });\n                                });\n                                updatePositionInfo($(this));\n                            },\n                            stop: function() {\n                                if (self.isEditMode()) {\n                                    let $selected = $canvas.find('.annotation-wrapper.active');\n                                    let positions = $selected.map(function() {\n                                        let thisPosition = $(this).position();\n                                        return {\n                                            id: $(this).data('item'),\n                                            left: thisPosition.left,\n                                            top: thisPosition.top,\n                                            bottom: thisPosition.top + $(this).height(),\n                                            right: thisPosition.left + $(this).width(),\n                                        };\n                                    }).get();\n\n                                    if (positions.find(x => x.left < 0)) {\n                                        positions.sort((a, b) => a.left - b.left);\n                                        let onLeft = positions.find(x => x.left < 0);\n                                        let id = onLeft.id;\n                                        let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('left', 0);\n                                        let distance = target.data('startPosition').left;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.data('startPosition');\n                                            let newLeft = position.left - distance;\n                                            $this.css('left', newLeft + 'px');\n                                        });\n                                    }\n\n                                    if (positions.find(x => x.top < 0)) {\n                                        positions.sort((a, b) => a.top - b.top);\n                                        let onTop = positions.find(x => x.top < 0);\n                                        let id = onTop.id;\n                                        let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('top', 0);\n                                        let distance = target.data('startPosition').top;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.data('startPosition');\n                                            let newTop = position.top - distance;\n                                            $this.css('top', newTop + 'px');\n                                        });\n                                    }\n\n                                    let canvasWidth = $canvas.width();\n                                    let canvasHeight = $canvas.height();\n                                    if (positions.find(x => x.right > canvasWidth)) {\n                                        positions.sort((a, b) => a.right - b.right);\n                                        let onRight = positions.find(x => x.right > canvasWidth);\n                                        let id = onRight.id;\n                                        let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('left', (canvasWidth - target.width() - 1) + 'px');\n                                        let distance = target.data('startPosition').left - target.position().left;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.data('startPosition');\n                                            let newLeft = position.left - distance;\n                                            $this.css('left', newLeft + 'px');\n                                        });\n                                    }\n\n                                    if (positions.find(x => x.bottom > canvasHeight)) {\n                                        positions.sort((a, b) => a.bottom - b.bottom);\n                                        let onBottom = positions.find(x => x.bottom > canvasHeight);\n                                        let id = onBottom.id;\n                                        let target = $canvas.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('top', (canvasHeight - target.height() - 1) + 'px');\n                                        let distance = target.data('startPosition').top - target.position().top;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.data('startPosition');\n                                            let newTop = position.top - distance;\n                                            $this.css('top', newTop + 'px');\n                                        });\n                                    }\n\n                                    getItems(false);\n                                    updatePositionInfo($(this));\n                                    $selected = $selected.map(function() {\n                                        return $(this).data('item');\n                                    }).get();\n\n                                    saveTracking($selected);\n                                }\n                            }\n                        });\n\n                        $canvas.find('.annotation-wrapper.resizable').resizable({\n                            containment: \"#canvas\",\n                            handles: \"all\",\n                            grid: [1, 1],\n                            minHeight: 1,\n                            minWidth: 1,\n                            resize: function(event) {\n                                if (self.isEditMode()) {\n                                    let type = $(this).data('type');\n                                    if (type == 'file' || type == 'audio' || type == 'stopwatch' || type == 'navigation'\n                                        || type == 'textblock') {\n                                        recalculatingTextSize($(this), type != 'textblock', type == 'textblock');\n                                    } else if (type == 'shape' && event.ctrlKey) {\n                                        $(this).resizable('option', 'aspectRatio', 1);\n                                    }\n                                    updatePositionInfo($(this));\n                                }\n                            },\n                            stop: function() {\n                                if (self.isEditMode()) {\n                                    let type = $(this).data('type');\n                                    if (type == 'file' || type == 'navigation' || type == 'textblock') {\n                                        recalculatingTextSize($(this), type != 'textblock', type == 'textblock');\n                                    } else if (type == 'shape') {\n                                        $(this).resizable('option', 'aspectRatio', false);\n                                    }\n                                    recalculatingSize($(this));\n                                    getItems(false);\n                                    saveTracking([$(this).data('item')]);\n                                    $(this).trigger('click');\n                                }\n                            }\n                        });\n                    }\n\n                    if (type != 'shape') {\n                        wrapper.on('mouseover', function() {\n                            if (!$(this).hasClass('resizable')) {\n                                return;\n                            }\n\n                            let aspectRatio =\n                                $(this).find('.annotation-content').width() / $(this).find('.annotation-content').height();\n                            if (wrapper.width() / wrapper.height() != aspectRatio && (type == 'image' || type == 'video')) {\n                                $(this).height((wrapper.width() / aspectRatio));\n                            }\n                            try {\n                                $(this).resizable('option', 'aspectRatio', $(this).find('.annotation-content').outerWidth() /\n                                    $(this).find('.annotation-content').outerHeight());\n                            } catch (e) {\n                                // Do nothing.\n                            }\n\n                        });\n                    }\n\n                    if (actives && actives.includes(id)) {\n                        wrapper.addClass('active');\n                        if (actives.length == 1) {\n                            setTimeout(function() {\n                                wrapper.trigger('mouseover');\n                                wrapper.trigger('click');\n                            }, 500);\n                        }\n                    }\n\n                });\n\n                // Handle behavior for each item\n                if (!self.isEditMode()) {\n                    $videoWrapper.off('click', `#canvas .annotation-wrapper`).on('click', `#canvas .annotation-wrapper`,\n                        function(e) {\n                            e.stopImmediatePropagation();\n                            let wrapper = $(this);\n                            let type = wrapper.data('type');\n                            switch (type) {\n                                case 'video':\n                                    var video = wrapper.find('video')[0];\n                                    if (video.paused || video.ended || video.currentTime === 0) {\n                                        video.play();\n                                    } else {\n                                        video.pause();\n                                    }\n                                    break;\n                                case 'hotspot':\n                                    var viewertype = wrapper.data('toggle') || wrapper.data('bs-toggle');\n                                    var hotspotid = wrapper.data('item');\n                                    var hotspot = items.find(x => x.id == hotspotid);\n                                    if (viewertype == 'modal') {\n                                        let title = hotspot.properties.formattedtitle;\n                                        let content = hotspot.properties.content.text;\n                                        let url = hotspot.properties.url;\n                                        let modal = `<div class=\"modal fade\" id=\"annotation-modal\" role=\"dialog\"\n                                         aria-labelledby=\"annotation-modal\"\n                                         aria-hidden=\"true\" data${self.isBS5 ? '-bs' : ''}-backdrop=\"static\"\n                                          data${self.isBS5 ? '-bs' : ''}-keyboard=\"false\">\n                             <div class=\"modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable\" role=\"document\">\n                                <div class=\"modal-content iv-rounded-lg\">\n                                    <div class=\"modal-header d-flex align-items-center shadow-sm iv-iv-pr-0\" id=\"title\">\n                                        <h5 class=\"modal-title text-truncate mb-0\">${title}</h5>\n                                        <button class=\"btn mx-2 p-0 close\" aria-label=\"Close\"\n                                         data${self.isBS5 ? '-bs' : ''}-dismiss=\"modal\">\n                                            <i class=\"bi bi-x-lg fa-fw\" style=\"font-size: x-large;\"></i>\n                                        </button>\n                                    </div>\n                                    <div class=\"modal-body\" id=\"content\">\n                                    <div class=\"loader\"></div>\n                                    </div>\n                                    ${url != '' ? `<div class=\"modal-footer bg-light p-2 rounded-bottom\">\n                                        <a href=\"${url}\" class=\"d-block w-100 text-right rotatex-360\" target=\"_blank\">\n                                        <i class=\"bi bi-arrow-right\"><i></i></i></a></div>` : ''}\n                                    </div>\n                                </div>\n                                </div>`;\n                                        $('#wrapper').append(modal);\n                                        $('#annotation-modal').modal('show');\n                                        $('#annotation-modal').on('hide.bs.modal', function() {\n                                            $('#annotation-modal').remove();\n                                        });\n                                        $('#annotation-modal').on('shown.bs.modal', async function() {\n                                            $('#annotation-modal .modal-body').fadeIn(300);\n                                            let $body = $('#annotation-modal .modal-body');\n                                            const html = await self.formatContent(content, annotation.contextid);\n                                            $body.html(html);\n                                            notifyFilter($body);\n                                        });\n                                    } else {\n                                        wrapper.popover('show');\n                                    }\n                                    break;\n                            }\n                            if ($(this).data('timestamp')) {\n                                self.player.seek($(this).data('timestamp'));\n                                self.player.play();\n                            }\n                        });\n\n                    $playerWrapper.off('click', `.popover-dismiss`).on('click', `.popover-dismiss`, function(e) {\n                        e.stopImmediatePropagation();\n                        $(this).closest('.popover').remove();\n                    });\n                }\n            }\n        };\n\n        // Check resize on video wrapper resize\n        let vwrapper = document.querySelector('#video-wrapper');\n        let resizeTimeout;\n\n        let resizeObserver = new ResizeObserver(() => {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(() => {\n            let existingwrapper = $canvas.find(`.annotation-wrapper`);\n            if (existingwrapper.length === 0) {\n                return;\n            }\n            existingwrapper.each(function() {\n                let wrapper = $(this);\n                let type = wrapper.data('type');\n                if (\n                type === 'textblock' ||\n                type === 'audio' ||\n                type === 'stopwatch' ||\n                type === 'file' ||\n                type === 'navigation'\n                ) {\n                recalculatingTextSize(wrapper, type !== 'textblock', type === 'textblock');\n                } else if (type === 'video') {\n                recalculatingSize(wrapper);\n                let aspectRatio =\n                    wrapper.find('.annotation-content').width() / wrapper.find('.annotation-content').height();\n                if (wrapper.width() / wrapper.height() !== aspectRatio) {\n                    wrapper.height(wrapper.width() / aspectRatio);\n                }\n                }\n                $canvas.css('font-size', $canvas.width() / 75 + 'px');\n            });\n            }, 100);\n        });\n        resizeObserver.observe(vwrapper);\n\n        // Ready to render items.\n        let items = [];\n        let tracking = [];\n        let trackingIndex = 0;\n        if (data.items != '' && data.items !== null) {\n            items = JSON.parse(data.items);\n            tracking.push({\n                items: JSON.stringify(items),\n                actives: null,\n                at: new Date().getTime(),\n            });\n        }\n        let draftitemid = data.draftitemid;\n\n        renderItems(items, null, false);\n\n        // Render the inline annotation toolbar\n        if (this.isEditMode()) {\n            $('#inlineannotation-btns').remove();\n            let inlineannotationitems = [\n                {\n                    'icon': 'bi bi-image',\n                    'type': 'media',\n                    'mediatype': 'image',\n                    'label': M.util.get_string('image', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-film',\n                    'type': 'media',\n                    'mediatype': 'video',\n                    'label': M.util.get_string('video', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-volume-up',\n                    'type': 'media',\n                    'mediatype': 'audio',\n                    'label': M.util.get_string('audio', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-alphabet-uppercase',\n                    'type': 'textblock',\n                    'mediatype': 'textblock',\n                    'label': M.util.get_string('text', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-circle-square',\n                    'type': 'shape',\n                    'mediatype': 'shape',\n                    'label': M.util.get_string('shape', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-stopwatch',\n                    'type': 'stopwatch',\n                    'mediatype': 'stopwatch',\n                    'label': M.util.get_string('stopwatch', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-file-earmark-arrow-down',\n                    'type': 'media',\n                    'mediatype': 'file',\n                    'label': M.util.get_string('inlinefile', 'local_ivinlineannotation'),\n                },\n                {\n                    'icon': 'bi bi-sign-turn-right',\n                    'type': 'navigation',\n                    'mediatype': 'navigation',\n                    'label': M.util.get_string('navigation', 'local_ivinlineannotation')\n                },\n                {\n                    'icon': 'bi bi-plus-circle',\n                    'type': 'hotspot',\n                    'mediatype': 'hotspot',\n                    'label': M.util.get_string('hotspot', 'local_ivinlineannotation'),\n                }\n            ];\n            const dataForTemplate = {\n                id: annotation.id,\n                items: inlineannotationitems,\n            };\n\n            Templates.render('local_ivinlineannotation/toolbar', dataForTemplate).then((html) => {\n                return $videoWrapper.before(html);\n            }).catch(() => {\n                // Do nothing.\n            });\n\n            self.enableColorPicker();\n        }\n\n        $(document).one('iv:playerSeek iv:playerPlay', function(e) {\n            if (seeking) {\n                return;\n            }\n            $('body').removeClass('disablekb');\n            let newTime = e.detail.time;\n            if (Math.floor(newTime) != annotation.timestamp) {\n                $(`#inlineannotation-btns`).remove();\n                $('.inlineannotation-popover').remove();\n                $canvas.remove();\n            }\n        });\n\n        $playerWrapper.off('click', `#canvas`).on('click', `#canvas`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            if (!self.isEditMode()) {\n                self.player.play();\n            } else {\n                $canvas.find('.annotation-wrapper').removeClass('active');\n                $('#inlineannotation-btns .btn').removeClass('active rotatey-360');\n                $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n            }\n        });\n\n        // End of view mode.\n        if (!self.isEditMode()) {\n            return;\n        }\n\n        /**\n         * Update tracking data for redo and undo\n         * @param {Array} actives array of active items\n         */\n        const saveTracking = (actives) => {\n            if (trackingIndex < tracking.length - 1) {\n                // Remove all the tracking data after the current index.\n                tracking = tracking.slice(0, trackingIndex + 1);\n            }\n            tracking.push({\n                items: JSON.stringify(items),\n                actives: actives,\n                at: new Date().getTime(),\n            });\n            tracking.sort((a, b) => a.at - b.at);\n            trackingIndex = tracking.length - 1;\n            $('#inlineannotation-btns #undo').removeAttr('disabled');\n            $('#inlineannotation-btns #redo').attr('disabled', 'disabled');\n            if (tracking.length == 1) {\n                $('#inlineannotation-btns #undo').attr('disabled', 'disabled');\n            }\n        };\n\n        /**\n         * Order items by layer.\n         * @param {Array} ids array of item ids\n         * @param {String} order asc or desc\n         * @returns {Array} sorted array of item ids\n         */\n        const sortItemsByLayer = (ids, order) => {\n            ids = ids.map(x => x.toString()); // Convert ids to string for consistency.\n            let targetItems = items.filter(item => {\n                const id = item.id.toString();\n                return ids.includes(id);\n            });\n            if (order == 'desc') {\n                targetItems.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n            } else {\n                targetItems.sort((a, b) => a.position['z-index'] - b.position['z-index']);\n            }\n\n            return targetItems.map(item => item.id);\n        };\n\n        /**\n         * Get highest z-index.\n         * @param {Array} itms array of items\n         * @returns {Number} top z-index\n         */\n        const getTopLayer = (itms) => {\n            if (itms.length == 0) {\n                return 5;\n            }\n            let ids = itms.map(item => item.id);\n            let sorted = sortItemsByLayer(ids, 'desc');\n            let zindex = itms.find(item => item.id == sorted[0]).position['z-index'];\n            return Number(zindex);\n        };\n\n        /**\n         * Get lowest z-index.\n         * @param {Array} itms array of items\n         * @returns {Number} bottom z-index\n         */\n        const getBottomLayer = (itms) => {\n            if (itms.length == 0) {\n                return 5;\n            }\n            let ids = itms.map(item => item.id);\n            let sorted = sortItemsByLayer(ids, 'asc');\n            let zindex = itms.find(item => item.id == sorted[0]).position['z-index'];\n            return Number(zindex);\n        };\n\n        /**\n         * Get all items from the annotation-canvas.\n         * @param {Boolean} updateid whether or not to update the id of the item.\n         */\n        const getItems = (updateid) => {\n            let newItems = [];\n            $canvas.find(`.annotation-wrapper`).each(function(index, element) {\n                const id = $(element).data('item');\n                let item = {\n                    \"type\": $(element).data('type'),\n                    \"position\": recalculatingSize($(element)),\n                };\n                item.id = id;\n                item.properties = items.find(x => x.id == id).properties;\n                if (updateid) {\n                    item.id = new Date().getTime() + index;\n                    $(element).attr('data-item', item.id);\n                }\n                newItems.push(item);\n            });\n            items = newItems;\n            draftStatus = 'draft';\n        };\n\n        $playerWrapper.off('click', `#inlineannotation-btns #save`).on('click', `#inlineannotation-btns #save`, function(e) {\n            e.stopImmediatePropagation();\n            getItems(false);\n            // Encode html tags\n            let cleanItems = JSON.stringify(items).replace(/</g, '&lt;').replace(/>/g, '&gt;');\n            let updateId = $canvas.data('id');\n            $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                method: \"POST\",\n                dataType: \"text\",\n                data: {\n                    action: 'quick_edit_field',\n                    sesskey: M.cfg.sesskey,\n                    id: updateId,\n                    field: 'content',\n                    contextid: annotation.contextid,\n                    draftitemid: draftitemid,\n                    value: cleanItems,\n                    cmid: self.cmid,\n                    token: self.token,\n                },\n                success: function(data) {\n                    let updated = JSON.parse(data);\n                    draftStatus = null;\n                    tracking = [];\n                    $('#inlineannotation-btns #redo, #inlineannotation-btns #undo').attr('disabled', 'disabled');\n                    self.dispatchEvent('annotationupdated', {\n                        annotation: updated,\n                        action: 'edit',\n                    });\n                }\n            });\n        });\n\n        $(document).off('click', `#inlineannotation-btns #closetoolbar`)\n            .on('click', `#inlineannotation-btns #closetoolbar`, function(e) {\n                e.stopImmediatePropagation();\n                if (draftStatus == 'draft') {\n                    Notification.saveCancel(\n                        M.util.get_string('unsavedchange', 'local_ivinlineannotation'),\n                        M.util.get_string('unsavedchangeconfirm', 'local_ivinlineannotation'),\n                        M.util.get_string('save', 'local_ivinlineannotation'),\n                        function() {\n                            // If the user clicks save, save the changes.\n                            $('#inlineannotation-btns #save').trigger('click');\n                            draftStatus = null;\n                            tracking = [];\n                            $(`#inlineannotation-btns #closetoolbar`).trigger('click');\n                        },\n                        function() {\n                            $(`#inlineannotation-btns`).remove();\n                            $('#canvas[data-id=\"' + annotation.id + '\"]').remove();\n                            $('body').removeClass('disablekb');\n                        }\n                    );\n                } else {\n                    $(`#inlineannotation-btns`).remove();\n                    $('#canvas[data-id=\"' + annotation.id + '\"]').remove();\n                    $('#content-region, #timeline-wrapper').removeClass('no-pointer-events');\n                    $('body').removeClass('disablekb');\n                }\n            });\n\n        $(document).off('click', `#inlineannotation-btns #hideshow`).on('click', `#inlineannotation-btns #hideshow`, function(e) {\n            e.stopImmediatePropagation();\n            if ($(this).find('i').hasClass('bi-eye-slash')) {\n                $('#canvas[data-id=\"' + annotation.id + '\"]').find('.annotation-wrapper').hide();\n            } else {\n                $('#canvas[data-id=\"' + annotation.id + '\"]').find('.annotation-wrapper').show();\n            }\n            $(this).find('i').toggleClass('bi-eye bi-eye-slash');\n        });\n        /**\n         * Handle form data when adding or editing an item.\n         * @param {Object} newItem data from form submission\n         * @param {String} type type of the item\n         * @param {Boolean} add adding or editing\n         */\n        const handleFormData = (newItem, type, add) => {\n            switch (type) {\n                case 'audio':\n                case 'file':\n                    if (add) {\n                        newItem.position.height = '40px';\n                        newItem.position.width = '130px';\n                    }\n                    break;\n                case 'textblock':\n                    if (add) {\n                        newItem.position.fontSize = '16px';\n                        newItem.position.lineHeight = '20px';\n                    }\n                    break;\n                case 'navigation':\n                case 'stopwatch':\n                    if (add) {\n                        newItem.position.height = '40px';\n                        newItem.position.width = '130px';\n                    }\n                    break;\n                case 'shape':\n                    if (add) {\n                        newItem.position.height = '100px';\n                        newItem.position.width = '100px';\n                    }\n                    break;\n                case 'video':\n                case 'image':\n                    newItem.position.height = 'auto';\n                    break;\n                case 'hotspot':\n                    if (add) {\n                        newItem.position.width = '5%';\n                    }\n                    break;\n            }\n\n            items.push(newItem);\n            saveTracking([newItem.id]);\n            renderItems([newItem], [newItem.id], true);\n        };\n\n        $playerWrapper.off('click', `#inlineannotation-btns .add-ia`).on('click', `#inlineannotation-btns .add-ia`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let annoid = $canvas.data('id');\n            let type = $(this).attr('data-mediatype');\n            if (type == 'stopwatch' && items.find(x => x.type == 'stopwatch')) {\n                self.addNotification(M.util.get_string('onlyonestopwatch', 'local_ivinlineannotation'), 'danger');\n                return;\n            }\n            let iaform = new ModalForm({\n                formClass: \"local_ivinlineannotation\\\\items\\\\\" + $(this).attr('data-type'),\n                args: {\n                    contextid: annotation.contextid,\n                    id: 0,\n                    type: type,\n                    annotationid: annoid,\n                },\n                modalConfig: {\n                    title: M.util.get_string('addinlineannotation', 'local_ivinlineannotation',\n                        M.util.get_string(type, 'local_ivinlineannotation')),\n                }\n            });\n\n            iaform.show();\n\n            iaform.addEventListener(iaform.events.LOADED, () => {\n                iaform.modal.modal.draggable({\n                    handle: \".modal-header\",\n                });\n                if (type == 'navigation' || type == 'image' || type == 'shape') {\n                    $(document).on('change', '[name=\"timestamp\"]', function(e) {\n                        e.preventDefault();\n                        let parts = $(this).val().split(':');\n                        let timestamp = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                        if (!self.isBetweenStartAndEnd(timestamp)) {\n                            let message = M.util.get_string('timemustbebetweenstartandendtime', 'local_ivinlineannotation', {\n                                \"start\": self.convertSecondsToHMS(self.start),\n                                \"end\": self.convertSecondsToHMS(self.end),\n                            });\n                            self.addNotification(message);\n                            $(this).val($(this).attr('data-initial-value'));\n                            return;\n                        }\n\n                        // Make sure the timestamp is not in the skip segment.\n                        if (self.isInSkipSegment(timestamp)) {\n                            self.addNotification(M.util.get_string('interactionisbetweentheskipsegment',\n                                'local_ivinlineannotation'));\n                            $(this).val($(this).attr('data-initial-value'));\n                            return;\n                        }\n                    });\n                }\n            });\n\n            iaform.addEventListener(iaform.events.FORM_SUBMITTED, (e) => {\n                e.stopImmediatePropagation();\n                getItems(false);\n                const highestOrder = getTopLayer(items);\n                let left = Math.random() * 100;\n                let top = Math.random() * 100;\n                let newItem = {\n                    \"id\": new Date().getTime(),\n                    \"type\": type,\n                    \"position\": {\n                        \"width\": \"30%\",\n                        \"left\": left + \"px\",\n                        \"top\": top + \"px\",\n                        \"z-index\": highestOrder + 1,\n                    },\n                    'properties': e.detail,\n                };\n                handleFormData(newItem, type, true);\n            });\n        });\n\n        $playerWrapper.off('click', `#inlineannotation-btns #edit`).on('click', `#inlineannotation-btns #edit`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let annnoid = $canvas.data('id');\n            let active = $('#edit-btns').attr('data-active');\n            getItems(false);\n            let item = items.find(x => x.id == active);\n            let type = item.type;\n            let formdata = {...item.properties};\n            formdata.contextid = annotation.contextid;\n            formdata.id = item.id;\n            formdata.annotationid = annnoid;\n            formdata.type = type;\n            let editform = new ModalForm({\n                formClass: \"local_ivinlineannotation\\\\items\\\\\" +\n                    (type == 'image' || type == 'video' || type == 'audio' || type == 'file' ? 'media' : type),\n                args: formdata,\n                modalConfig: {\n                    title: M.util.get_string('editinlineannotation', 'local_ivinlineannotation',\n                        M.util.get_string(type, 'local_ivinlineannotation')),\n                }\n            });\n\n            editform.show();\n\n            editform.addEventListener(editform.events.LOADED, () => {\n                editform.modal.modal.draggable({\n                    handle: \".modal-header\",\n                });\n                if (type == 'navigation' || type == 'image' || type == 'shape') {\n                    $(document).on('change', '[name=\"timestamp\"]', function(e) {\n                        e.preventDefault();\n                        let parts = $(this).val().split(':');\n                        let timestamp = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                        if (!self.isBetweenStartAndEnd(timestamp)) {\n                            let message = M.util.get_string('timemustbebetweenstartandendtime', 'mod_interactivevideo', {\n                                \"start\": self.convertSecondsToHMS(self.start),\n                                \"end\": self.convertSecondsToHMS(self.end),\n                            });\n                            self.addNotification(message);\n                            $(this).val($(this).attr('data-initial-value'));\n                            return;\n                        }\n\n                        // Make sure the timestamp is not in the skip segment.\n                        if (self.isInSkipSegment(timestamp)) {\n                            self.addNotification(M.util.get_string('interactionisbetweentheskipsegment', 'mod_interactivevideo'));\n                            $(this).val($(this).attr('data-initial-value'));\n                            return;\n                        }\n                    });\n                }\n            });\n\n            editform.addEventListener(editform.events.FORM_SUBMITTED, (e) => {\n                e.stopImmediatePropagation();\n                getItems(false);\n                item = items.find(x => x.id == active);\n                item.properties = e.detail;\n                // Remove the item from the annotation-canvas\n                $videoWrapper.find(`.annotation-wrapper[data-item=\"${active}\"]`).remove();\n                items = items.filter(x => x.id != active);\n                handleFormData(item, type, false);\n            });\n        });\n\n        $canvas.off('click', `.annotation-wrapper`).on('click', `.annotation-wrapper`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            if (!e.ctrlKey && !e.metaKey) {\n                $canvas.find('.annotation-wrapper').removeClass('active');\n                $(this).addClass('active');\n                this.focus();\n                recalculatingSize($(this));\n            } else {\n                if ($(this).hasClass('active')) {\n                    $(this).removeClass('active');\n                } else {\n                    $(this).addClass('active');\n                    this.focus();\n                }\n            }\n\n            if (!isNaN(Number($(this).data('group')))) {\n                let group = $(this).data('group');\n                $canvas.find(`.annotation-wrapper[data-group=\"${group}\"]`).addClass('active');\n            }\n\n            recalculatingSize($(this));\n\n            let activewrapper = $canvas.find('.annotation-wrapper.active');\n            if (activewrapper.length == 0) {\n                $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n                $('#inlineannotation-btns #edit').attr('disabled', 'disabled');\n                $('#inlineannotation-btns #edit').removeAttr('disabled');\n            } else {\n                let dataActive = activewrapper.map(function() {\n                    return $(this).data('item');\n                }).get();\n                $('#edit-btns').attr('data-active', dataActive).addClass('d-flex').removeClass('d-none');\n                if (activewrapper.length > 1) {\n                    $('#inlineannotation-btns #edit').attr('disabled', 'disabled');\n                    $('#edit-btns #position').addClass('d-none');\n                } else {\n                    $('#inlineannotation-btns #edit').removeAttr('disabled');\n                    $('#edit-btns #position').removeClass('d-none');\n                }\n            }\n\n            // Enable ungroup button if the active items are grouped.\n            let grouping = activewrapper.map(function() {\n                if (isNaN($(this).data('group')) || $(this).data('group') == '') {\n                    return '';\n                }\n                return $(this).data('group');\n            }).get();\n\n            grouping = [...new Set(grouping)];\n\n            if (activewrapper.length < 2) {\n                $('#inlineannotation-btns #ungroup, #inlineannotation-btns #group').attr('disabled', 'disabled').addClass('d-none');\n            } else {\n                if (grouping.length == 1) {\n                    if (isNaN(grouping[0]) || grouping[0] == '') {\n                        $('#inlineannotation-btns #ungroup').attr('disabled', 'disabled').addClass('d-none');\n                        $('#inlineannotation-btns #group').removeAttr('disabled').removeClass('d-none');\n                    } else {\n                        $('#inlineannotation-btns #ungroup').removeAttr('disabled').removeClass('d-none');\n                        $('#inlineannotation-btns #group').attr('disabled', 'disabled').addClass('d-none');\n                    }\n                } else if (grouping.length > 1) {\n                    $('#inlineannotation-btns #ungroup, #inlineannotation-btns #group').removeAttr('disabled')\n                        .removeClass('d-none');\n                }\n            }\n        });\n\n        $canvas.off('dblclick', '.annotation-wrapper').on('dblclick', '.annotation-wrapper', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).trigger('click');\n            $('#inlineannotation-btns #edit').trigger('click');\n        });\n\n        $(document).off('click', `#inlineannotation-btns #undo`).on('click', `#inlineannotation-btns #undo`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            if (trackingIndex == 0) {\n                return;\n            }\n            trackingIndex--;\n            const instance = tracking[trackingIndex];\n            items = JSON.parse(instance.items);\n            renderItems(items, instance.actives, false);\n            if (trackingIndex == 0) {\n                $('#inlineannotation-btns #undo').attr('disabled', 'disabled');\n                $('#inlineannotation-btns #redo').removeAttr('disabled');\n            } else {\n                $('#inlineannotation-btns #undo').removeAttr('disabled');\n                if (trackingIndex == tracking.length - 1) {\n                    $('#inlineannotation-btns #redo').attr('disabled', 'disabled');\n                } else {\n                    $('#inlineannotation-btns #redo').removeAttr('disabled');\n                }\n            }\n        });\n\n        $(document).off('click', `#inlineannotation-btns #redo`).on('click', `#inlineannotation-btns #redo`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            if (trackingIndex == tracking.length - 1) {\n                return;\n            }\n            trackingIndex++;\n            const instance = tracking[trackingIndex];\n            items = JSON.parse(instance.items);\n            renderItems(items, instance.actives, false);\n            if (trackingIndex == tracking.length - 1) {\n                $('#inlineannotation-btns #redo').attr('disabled', 'disabled');\n                $('#inlineannotation-btns #undo').removeAttr('disabled');\n            } else {\n                $('#inlineannotation-btns #redo').removeAttr('disabled');\n                if (trackingIndex == 0) {\n                    $('#inlineannotation-btns #undo').attr('disabled', 'disabled');\n                } else {\n                    $('#inlineannotation-btns #undo').removeAttr('disabled');\n                }\n            }\n        });\n\n        const updateOrder = (active, direction) => {\n            // First sort items by z-index descending\n            getItems(false);\n            items.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n            let activeIndex = items.findIndex(x => x.id == active);\n            let activeItem = items[activeIndex];\n            let currentzIndex = activeItem.position['z-index'];\n            let affectedItem = null;\n            let affectedItemIndex = null;\n            if (direction == 'up') {\n                if (activeIndex == 0) {\n                    return;\n                }\n                affectedItemIndex = activeIndex - 1;\n                affectedItem = items[affectedItemIndex];\n                activeItem.position['z-index'] = affectedItem.position['z-index'];\n                affectedItem.position['z-index'] = currentzIndex;\n            } else {\n                if (activeIndex == items.length - 1) {\n                    return;\n                }\n                affectedItemIndex = activeIndex + 1;\n                affectedItem = items[affectedItemIndex];\n                activeItem.position['z-index'] = affectedItem.position['z-index'];\n                affectedItem.position['z-index'] = currentzIndex;\n            }\n            items[activeIndex] = activeItem;\n            items[affectedItemIndex] = affectedItem;\n            $(`.annotation-wrapper[data-item=\"${active}\"]`).css(activeItem.position);\n            $(`.annotation-wrapper[data-item=\"${affectedItem.id}\"]`).css(affectedItem.position);\n            saveTracking([active]);\n        };\n\n        // Group the active items\n        $(document).off('click', `#inlineannotation-btns #group`).on('click', `#inlineannotation-btns #group`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).attr('disabled', 'disabled').addClass('d-none');\n            $('#inlineannotation-btns #ungroup').removeAttr('disabled').removeClass('d-none');\n            getItems(false);\n            let active = $canvas.find('.annotation-wrapper.active').map(function() {\n                return $(this).data('item');\n            }).get();\n            const group = new Date().getTime();\n            active.forEach((item, i) => {\n                let activeItem = $canvas.find(`.annotation-wrapper[data-item=\"${item}\"]`);\n                let targetIndex = items.findIndex(x => x.id == item);\n                let target = JSON.parse(JSON.stringify(items[targetIndex]));\n                target.position.group = group;\n                items[targetIndex] = target;\n                activeItem.remove();\n                renderItems([target], null, true);\n                if (i == active.length - 1) {\n                    renderItems([], active, true);\n                }\n            });\n            saveTracking(active);\n        });\n\n        $(document).off('click', `#inlineannotation-btns #ungroup`).on('click', `#inlineannotation-btns #ungroup`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).attr('disabled', 'disabled').addClass('d-none');\n            $(`#inlineannotation-btns #group`).removeAttr('disabled').removeClass('d-none');\n            getItems(false);\n            let active = $canvas.find('.annotation-wrapper.active').map(function() {\n                return $(this).data('item');\n            }).get();\n            active.forEach((item, i) => {\n                let activeItem = $canvas.find(`.annotation-wrapper[data-item=\"${item}\"]`);\n                let targetIndex = items.findIndex(x => x.id == item);\n                let target = JSON.parse(JSON.stringify(items[targetIndex]));\n                delete target.position.group;\n                items[targetIndex] = target;\n                activeItem.remove();\n                renderItems([target], null, true);\n                if (i == active.length - 1) {\n                    renderItems([], active, true);\n                }\n            });\n            saveTracking(active);\n        });\n\n        $playerWrapper.off('click', `#inlineannotation-btns #up`).on('click', `#inlineannotation-btns #up`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            const topLayer = getTopLayer(items);\n            // Check if the active elements are already in the correct order based on their index positions in the items array\n            if (active.length > 1) {\n                active = sortItemsByLayer(active, 'desc');\n                let indexes = [];\n                items.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n                active.forEach((item) => {\n                    indexes.push(items.findIndex(x => x.id == item));\n                });\n                indexes.sort((a, b) => a - b);\n                if (Math.abs(indexes[0] - indexes[indexes.length - 1]) == active.length - 1) {\n                    if (Number(items[indexes[0]].position['z-index']) == topLayer) {\n                        return;\n                    }\n                }\n            }\n            active.forEach((item) => {\n                updateOrder(item, 'up');\n            });\n            getItems(false);\n            updatePositionInfo($(`.annotation-wrapper[data-item=\"${active[0]}\"]`));\n        });\n\n        $playerWrapper.off('click', `#inlineannotation-btns #down`).on('click', `#inlineannotation-btns #down`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            const bottomLayer = getBottomLayer(items);\n            // Check if the active elements are already in the correct order based on their index positions in the items array\n            if (active.length > 1) {\n                active = sortItemsByLayer(active, 'asc');\n                let indexes = [];\n                items.sort((a, b) => a.position['z-index'] - b.position['z-index']);\n                active.forEach((item) => {\n                    indexes.push(items.findIndex(x => x.id == item));\n                });\n                indexes.sort((a, b) => a - b);\n                if (Math.abs(indexes[0] - indexes[indexes.length - 1]) == active.length - 1) {\n                    if (Number(items[indexes[0]].position['z-index']) == bottomLayer) {\n                        return;\n                    }\n                }\n            }\n            active.forEach((item) => {\n                updateOrder(item, 'down');\n            });\n            getItems(false);\n            updatePositionInfo($(`.annotation-wrapper[data-item=\"${active[0]}\"]`));\n        });\n\n        $playerWrapper.off('click', `#inlineannotation-btns #delete`).on('click', `#inlineannotation-btns #delete`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            active.forEach((item) => {\n                let activeItem = $canvas.find(`.annotation-wrapper[data-item=\"${item}\"]`);\n                activeItem.remove();\n                $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n            });\n            getItems(false);\n            saveTracking(null);\n        });\n\n        $playerWrapper.off('click', `#inlineannotation-btns #copy`).on('click', `#inlineannotation-btns #copy`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            getItems(false);\n            // Copy the active item\n            const highestOrder = getTopLayer(items);\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            active = sortItemsByLayer(active, 'asc');\n            let newItems = [];\n            for (let i = 0; i < active.length; i++) {\n                let a = active[i];\n                let activeItem = $canvas.find(`.annotation-wrapper[data-item=\"${a}\"]`);\n                activeItem.removeClass('active');\n                const item = items.find(x => x.id == a);\n                let newItem = JSON.parse(JSON.stringify(item));\n                newItem.position = recalculatingSize(activeItem);\n                if (item.position.group) {\n                    newItem.position.group = Number(item.position.group) + 1;\n                }\n                newItem.id = new Date().getTime() + i;\n                newItems.push(newItem);\n                newItem.position['z-index'] = Number(highestOrder) + i + 1;\n                items.push(newItem);\n                if (i == active.length - 1) {\n                    const newItemIds = newItems.map(x => x.id);\n                    $('#edit-btns').attr('data-active', newItemIds.join(',')).addClass('d-flex').removeClass('d-none');\n                    renderItems(newItems, newItemIds, true);\n                    // Put focus on the first element\n                    getItems(false);\n                    document.querySelector('.annotation-wrapper.active').focus();\n                    updatePositionInfo($(`.annotation-wrapper[data-item=\"${newItem.id}\"]`));\n                    saveTracking(newItemIds);\n                }\n            }\n        });\n\n        // Move items with keyboard arrow keys, ctrl + up to layer up, and ctrl + down to layer down.\n        $playerWrapper.on('keydown', '#canvas .annotation-wrapper', function(e) {\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            for (let i = 0; i < active.length; i++) {\n                let a = active[i];\n                let activeItem = $canvas.find(`.annotation-wrapper[data-item=\"${a}\"]`);\n                if (activeItem != undefined) {\n                    let position = activeItem.position();\n                    position['z-index'] = parseInt(activeItem.css('z-index'));\n                    let ctrl = e.ctrlKey || e.metaKey;\n                    let step = 1;\n                    // Prevent page scroll\n                    e.preventDefault();\n                    e.stopImmediatePropagation();\n                    switch (e.key) {\n                        case 'ArrowUp':\n                            if (position.top > 0) {\n                                position.top = position.top - step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'ArrowDown':\n                            if (position.top + activeItem.outerHeight() < $canvas.height()) {\n                                position.top = position.top + step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'ArrowLeft':\n                            if (position.left > 0) {\n                                position.left = position.left - step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'ArrowRight':\n                            if (position.left + activeItem.outerWidth() < $canvas.width()) {\n                                position.left = position.left + step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'Delete':\n                            $(`#inlineannotation-btns #delete`).trigger('click');\n                            return;\n                        case 'd': // Ctrl + d to duplicate\n                            if (ctrl) {\n                                $(`#inlineannotation-btns #copy`).trigger('click');\n                            }\n                            return;\n                        default:\n                            return;\n                    }\n                    activeItem.css(position);\n                    recalculatingSize(activeItem);\n                }\n            }\n        });\n\n        $(document).on('annotationdeleted', function(e) {\n            let deleted = e.originalEvent.detail.annotation;\n            let annoid = $canvas.data('id');\n            if (annoid == deleted.id) {\n                $videoWrapper.find(`#canvas[data-id='${annoid}']`).remove();\n                $(`#inlineannotation-btns`).remove();\n            }\n        });\n\n        // Confirm draft saved.\n        window.addEventListener('beforeunload', (e) => {\n            if (draftStatus !== null) {\n                const confirmationMessage = M.util.get_string('unsavedchanges', 'mod_interactivevideo');\n                e.returnValue = confirmationMessage;\n                return confirmationMessage;\n            }\n            return true;\n        });\n\n        self.timepicker();\n        $(document).on('click', '.pickatime button', function() {\n            seeking = true;\n        });\n        $(document).on('click', '#confirmtime', async function() {\n            seeking = false;\n        });\n    }\n    /**\n     * What happens when an item runs\n     * @param {Object} annotation The annotation object\n     * @returns {void}\n     */\n    async runInteraction(annotation) {\n        let self = this;\n        await this.player.pause();\n        this.renderContainer(annotation);\n        if (this.isEditMode()) {\n            annotation.editmode = true; // Use editmode to render the draft content (i.e draft.php vs plugin.php).\n            // Disable the content-region and the timeline-wrapper.\n            $('#content-region, #timeline-wrapper').addClass('no-pointer-events');\n        }\n        // We don't need to run the render method every time the content is applied. We can cache the content.\n        if (!self.cache[annotation.id] || self.isEditMode()) {\n            self.cache[annotation.id] = await self.render(annotation, 'json');\n        }\n        let content = self.cache[annotation.id];\n        this.postContentRender(annotation, content);\n        document.querySelector('#canvas').focus();\n        $('body').addClass('disablekb');\n    }\n}"],"names":["InlineAnnotation","Base","postEditCallback","roundToTwo","num","Math","round","renderContainer","annotation","videoWrapper","find","remove","append","id","updateAspectRatio","async","video","reset","elem","hasClass","ratio","this","displayoptions","usefixedratio","player","aspectratio","videowrapperaspect","width","height","videowrapperwidth","videowrapperheight","css","resizeTimeout","vwrapper","document","querySelector","ResizeObserver","clearTimeout","setTimeout","observe","on","timepicker","options","modal","disablelist","required","self","off","e","preventDefault","$this","currenttime","getCurrentTime","field","data","fieldval","val","parts","split","time","Number","seek","closest","addClass","hide","before","M","util","get_string","removeClass","formattedTime","convertSecondsToHMS","show","pause","start","postContentRender","$videoWrapper","$playerWrapper","$canvas","draftStatus","seeking","convertSecondsToMMSS","seconds","minutes","floor","updatePositionInfo","w","outerWidth","hw","outerHeight","t","position","top","l","left","z","text","recalculatingSize","message","removeAttr","h","g","group","recalculatingTextSize","button","multiline","fontSize","padding","rowCount","length","style","renderFile","wrapper","item","prop","type","wrapperhtml","rounded","shadow","url","formattedlabel","isEditMode","playButton","audioSrc","media","Audio","stopImmediatePropagation","paused","ended","currentTime","play","totaltime","onloadedmetadata","duration","onended","ontimeupdate","autoplay","trigger","one","renderStopwatch","timer","alarm","clearInterval","intervalfunction","setInterval","playalarmsound","playsoundatinterval","intervaltime","playsoundatend","cfg","wwwroot","onplay","allowpause","renderItems","elements","actives","update","empty","forEach","active","count","properties","replace","resizable","attr","timestamp","gotourl","formattedalttext","renderImage","showcontrol","playsInline","onpause","renderVideo","renderNavigation","textparts","textblock","part","trim","alignment","textfont","undefined","lineHeight","bold","italic","underline","textcolor","bgcolor","borderwidth","bordercolor","renderTextblock","opacity","shape","renderShape","formattedtitle","color","usemodal","isBS5","popover","container","html","template","$body","formatContent","content","contextid","openbydefault","renderHotspot","draggable","containment","cursor","grid","handle","each","drag","event","ui","$selected","originalPosition","positions","map","bottom","right","get","x","sort","a","b","target","distance","canvasWidth","canvasHeight","not","stop","thisPosition","newLeft","newTop","getItems","saveTracking","handles","minHeight","minWidth","resize","ctrlKey","aspectRatio","includes","viewertype","hotspotid","hotspot","items","title","fadeIn","existingwrapper","tracking","trackingIndex","JSON","parse","push","stringify","at","Date","getTime","draftitemid","inlineannotationitems","dataForTemplate","render","then","catch","enableColorPicker","newTime","detail","slice","sortItemsByLayer","ids","order","toString","targetItems","filter","getTopLayer","itms","sorted","zindex","updateid","newItems","index","element","cleanItems","updateId","ajax","method","dataType","action","sesskey","value","cmid","token","success","updated","dispatchEvent","saveCancel","toggleClass","handleFormData","newItem","add","annoid","addNotification","iaform","ModalForm","formClass","args","annotationid","modalConfig","addEventListener","events","LOADED","isBetweenStartAndEnd","end","isInSkipSegment","FORM_SUBMITTED","highestOrder","random","annnoid","formdata","editform","metaKey","focus","isNaN","activewrapper","dataActive","grouping","Set","instance","updateOrder","direction","activeIndex","findIndex","activeItem","currentzIndex","affectedItem","affectedItemIndex","i","targetIndex","topLayer","indexes","abs","bottomLayer","getBottomLayer","newItemIds","join","parseInt","ctrl","step","key","deleted","originalEvent","window","confirmationMessage","returnValue","editmode","cache"],"mappings":"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"}